---
- name: Ensure dependencies are installed
  ansible.builtin.package:
    name:
      - gpg
      - wget
      - curl
    state: present
    update_cache: yes

- name: Proxmox Backup Client Installation Block (Alpine)
  block:
    - name: Install extraction dependencies (Alpine)
      community.general.apk:
        name: [binutils, xz]
        state: present
        update_cache: yes

    - name: Create temporary directory for extraction
      ansible.builtin.tempfile:
        state: directory
        suffix: pbs_extract
      register: pbs_temp_dir

    - name: Download Proxmox Backup Client static deb
      ansible.builtin.get_url:
        url: "{{ proxmox_alpine_static_deb }}"
        dest: "{{ pbs_temp_dir.path }}/pbs-client.deb"

    - name: Extract deb package
      ansible.builtin.shell:
        cmd: "ar x pbs-client.deb"
        chdir: "{{ pbs_temp_dir.path }}"
      changed_when: false

    - name: Extract data.tar
      ansible.builtin.shell:
        cmd: "tar -xJf data.tar.xz"
        chdir: "{{ pbs_temp_dir.path }}"
      changed_when: false

    - name: Install static binary
      ansible.builtin.copy:
        src: "{{ pbs_temp_dir.path }}/usr/bin/proxmox-backup-client"
        dest: /usr//bin/proxmox-backup-client
        mode: '0755'
        remote_src: yes

    - name: Cleanup temporary directory
      ansible.builtin.file:
        path: "{{ pbs_temp_dir.path }}"
        state: absent
  when: 
    - ansible_os_family == 'Alpine'
    - ansible_architecture in ['x86_64', 'amd64', 'x86']
  become: yes

- name: Proxmox Backup Client Installation Block (Debian/Ubuntu)
  block:
    - name: Create directory for GPG keys
      file:
        path: /usr/share/keyrings
        state: directory
        mode: '0755'

    - name: Download Proxmox GPG key
      get_url:
        url: "{{ pbs_gpg_key_url }}"
        dest: "{{ pbs_gpg_key_dest }}"
        mode: '0644'

    # Specific logic for Debian 13 (Trixie)
    - name: Configure Proxmox repo for Debian 13 (DEB822 format)
      copy:
        dest: /etc/apt/sources.list.d/pbs-client.sources
        content: |
          Types: deb
          URIs: http://download.proxmox.com/debian/pbs-client
          Suites: trixie
          Components: main
          Signed-By: {{ pbs_gpg_key_dest }}
        owner: root
        group: root
        mode: '0644'
      when: (ansible_distribution == "Debian" and ansible_distribution_major_version == "13")
      register: pbs_repo_trixie

    # Fallback logic for older Debian/Ubuntu versions
    - name: Configure Proxmox repo for older versions
      apt_repository:
        repo: "deb [signed-by={{ pbs_gpg_key_dest }}] http://download.proxmox.com/debian/pbs-client trixie main"
        state: present
        filename: pbs-client
      when: not (ansible_distribution == "Debian" and ansible_distribution_major_version == "13")
      register: pbs_repo_legacy

    - name: Install proxmox-backup-client Debian
      apt:
        name: proxmox-backup-client
        state: present
        update_cache: yes
      when: ansible_distribution == "Debian"
    
    - name: Install proxmox-backup-client Ubuntu
      apt:
        name: proxmox-backup-client-static
        state: present
        update_cache: yes
      when: ansible_distribution == "Ubuntu"

  # This condition ensures the entire block is skipped on non-x86 hardware or non-Debian family
  when: 
    - ansible_architecture in ['x86_64', 'amd64', 'x86']
    - ansible_os_family == 'Debian'
  become: yes

- name: Install the arm package directly (Debian/Ubuntu)
  ansible.builtin.apt:
    deb: "{{ proxmox_arm_client }}"
  when: 
    - ansible_architecture in ['arm64', 'aarch64']
    - ansible_os_family == 'Debian'
  become: yes

- name: Initialize pbs_host as null
  ansible.builtin.set_fact:
    pbs_host: null

- name: Try to ping pbs candidates
  ansible.builtin.command: "ping -c 1 {{ item }}"
  register: ping_result
  ignore_errors: true
  changed_when: false
  loop: "{{ pbs_check_list }}"
  # Only run if we haven't found a working host yet
  when: pbs_host is none

- name: Set pbs_host based on successful ping
  ansible.builtin.set_fact:
    pbs_host: "{{ item.item }}"
  loop: "{{ ping_result.results }}"
  when:
    - pbs_host is none
    - item.rc == 0
  no_log: true # Keeps the output clean

- name: Fallback to default IP if no host responded
  ansible.builtin.set_fact:
    pbs_host: "{{ pbs_fallback_ip }}"
  when: pbs_host is none

- name: Create backup.sh script in /root
  template:
    src: backup.sh.j2
    dest: /root/backup.sh
    owner: root
    group: root
    mode: '0700'
    backup: yes
  # Prevents the password from leaking into Ansible logs
  no_log: true
  become: yes

- name: Ensure cron package is installed
  ansible.builtin.package:
    name: "{{ 'dcron' if ansible_os_family == 'Alpine' else 'cron' }}"
    state: present
    update_cache: yes
  become: yes

- name: Ensure cron service is started and enabled
  ansible.builtin.service:
    name: "{{ 'crond' if ansible_os_family == 'Alpine' else 'cron' }}"
    state: started
    enabled: yes
  become: yes

- name: Set random hour and minute for the cron job
  set_fact:
    cron_minute: "{{ 59 | random(seed=inventory_hostname) }}"
    cron_hour: "{{ 23 | random(seed=inventory_hostname) }}"

- name: Create the randomized daily cron job
  cron:
    name: "{{ backup_cron_job_name }}"
    minute: "{{ cron_minute }}"
    hour: "{{ cron_hour }}"
    job: "{{ backup_cron_command }}"
    user: root
    state: present
  become: yes

- name: Inform which time was selected
  debug:
    msg: "Command '{{ backup_cron_command }}' scheduled for {{ cron_hour }}:{{ cron_minute }} daily."

---
- name: Ensure dependencies are installed
  apt:
    name:
      - gpg
      - wget
    state: present
    update_cache: yes
- name: Proxmox Backup Client Installation Block
  block:
    - name: Create directory for GPG keys
      file:
        path: /usr/share/keyrings
        state: directory
        mode: '0755'

    - name: Download Proxmox GPG key
      get_url:
        url: "{{ pbs_gpg_key_url }}"
        dest: "{{ pbs_gpg_key_dest }}"
        mode: '0644'

    # Specific logic for Debian 13 (Trixie)
    - name: Configure Proxmox repo for Debian 13 (DEB822 format)
      copy:
        dest: /etc/apt/sources.list.d/pbs-client.sources
        content: |
          Types: deb
          URIs: http://download.proxmox.com/debian/pbs-client
          Suites: trixie
          Components: main
          Signed-By: {{ pbs_gpg_key_dest }}
        owner: root
        group: root
        mode: '0644'
      when: (ansible_distribution == "Debian" and ansible_distribution_major_version == "13")
      register: pbs_repo_trixie

    # Fallback logic for older Debian/Ubuntu versions
    - name: Configure Proxmox repo for older versions
      apt_repository:
        repo: "deb [signed-by={{ pbs_gpg_key_dest }}] http://download.proxmox.com/debian/pbs-client trixie main"
        state: present
        filename: pbs-client
      when: not (ansible_distribution == "Debian" and ansible_distribution_major_version == "13")
      register: pbs_repo_legacy

    - name: Install proxmox-backup-client Debian
      apt:
        name: proxmox-backup-client
        state: present
        update_cache: yes
      when: ansible_distribution == "Debian"
    
    - name: Install proxmox-backup-client Ubuntu
      apt:
        name: proxmox-backup-client-static
        state: present
        update_cache: yes
      when: ansible_distribution == "Ubuntu"

  # This condition ensures the entire block is skipped on non-x86 hardware
  when: ansible_architecture in ['x86_64', 'amd64', 'x86']

- name: Install the arm package directly
  ansible.builtin.apt:
    deb: "{{ proxmox_arm_client }}"
  when: ansible_architecture in ['arm64', 'aarch64']

- name: Initialize pbs_host as null
  ansible.builtin.set_fact:
    pbs_host: null

- name: Try to ping pbs candidates
  ansible.builtin.command: "ping -c 1 {{ item }}"
  register: ping_result
  ignore_errors: true
  changed_when: false
  loop: "{{ pbs_check_list }}"
  # Only run if we haven't found a working host yet
  when: pbs_host is none

- name: Set pbs_host based on successful ping
  ansible.builtin.set_fact:
    pbs_host: "{{ item.item }}"
  loop: "{{ ping_result.results }}"
  when:
    - pbs_host is none
    - item.rc == 0
  no_log: true # Keeps the output clean

- name: Fallback to default IP if no host responded
  ansible.builtin.set_fact:
    pbs_host: "{{ pbs_fallback_ip }}"
  when: pbs_host is none

- name: Create backup.sh script in /root
  template:
    src: backup.sh.j2
    dest: /root/backup.sh
    owner: root
    group: root
    mode: '0700'
    backup: yes
  # Prevents the password from leaking into Ansible logs
  no_log: true

- name: Ensure cron package is installed
  apt:
    name: cron
    state: present
    update_cache: yes

- name: Ensure cron service is started and enabled
  service:
    name: cron
    state: started
    enabled: yes

- name: Set random hour and minute for the cron job
  set_fact:
    cron_minute: "{{ 59 | random(seed=inventory_hostname) }}"
    cron_hour: "{{ 23 | random(seed=inventory_hostname) }}"

- name: Create the randomized daily cron job
  cron:
    name: "{{ backup_cron_job_name }}"
    minute: "{{ cron_minute }}"
    hour: "{{ cron_hour }}"
    job: "{{ backup_cron_command }}"
    user: root
    state: present

- name: Inform which time was selected
  debug:
    msg: "Command '{{ backup_cron_command }}' scheduled for {{ cron_hour }}:{{ cron_minute }} daily."

---
- name: Proxmox Backup Client Installation Block
  block:
    - name: Ensure dependencies are installed
      apt:
        name:
          - gpg
          - wget
        state: present
        update_cache: yes

    - name: Create directory for GPG keys
      file:
        path: /usr/share/keyrings
        state: directory
        mode: '0755'

    - name: Download Proxmox GPG key
      get_url:
        url: "{{ pbs_gpg_key_url }}"
        dest: "{{ pbs_gpg_key_dest }}"
        mode: '0644'

    # Specific logic for Debian 13 (Trixie)
    - name: Configure Proxmox repo for Debian 13 (DEB822 format)
      copy:
        dest: /etc/apt/sources.list.d/pbs-client.sources
        content: |
          Types: deb
          URIs: http://download.proxmox.com/debian/pbs-client
          Suites: trixie
          Components: main
          Signed-By: {{ pbs_gpg_key_dest }}
        owner: root
        group: root
        mode: '0644'
      when: ansible_distribution == "Debian" and ansible_distribution_major_version == "13"
      register: pbs_repo_trixie

    # Fallback logic for older Debian/Ubuntu versions
    - name: Configure Proxmox repo for older versions
      apt_repository:
        repo: "deb http://download.proxmox.com/debian/pbs-client {{ ansible_distribution_release }} pbs-client-no-subscription"
        state: present
        filename: pbs-client
      when: not (ansible_distribution == "Debian" and ansible_distribution_major_version == "13")
      register: pbs_repo_legacy

    - name: Install proxmox-backup-client Debian
      apt:
        name: proxmox-backup-client
        state: present
        update_cache: yes
      when: ansible_distribution == "Debian"
    
    - name: Install proxmox-backup-client Ubuntu
      apt:
        name: proxmox-backup-client-static
        state: present
        update_cache: yes
      when: ansible_distribution == "Ubuntu"

    - name: Create backup.sh script in /root
      template:
        src: backup.sh.j2
        dest: /root/backup.sh
        owner: root
        group: root
        mode: '0700'
      # Prevents the password from leaking into Ansible logs
      no_log: true

  # This condition ensures the entire block is skipped on non-x86 hardware
  when: ansible_architecture in ['x86_64', 'amd64', 'x86']

- name: Notify if skipped due to architecture
  debug:
    msg: "Skipping Proxmox Backup Client installation: Architecture {{ ansible_architecture }} is not supported."
  when: ansible_architecture not in ['x86_64', 'amd64', 'x86']

- name: Set random hour and minute for the cron job
  set_fact:
    cron_minute: "{{ 59 | random(seed=inventory_hostname) }}"
    cron_hour: "{{ 23 | random(seed=inventory_hostname) }}"

- name: Create the randomized daily cron job
  cron:
    name: "{{ backup_cron_job_name }}"
    minute: "{{ cron_minute }}"
    hour: "{{ cron_hour }}"
    job: "{{ backup_cron_command }}"
    user: root
    state: present

- name: Inform which time was selected
  debug:
    msg: "Command '{{ backup_cron_command }}' scheduled for {{ cron_hour }}:{{ cron_minute }} daily."
